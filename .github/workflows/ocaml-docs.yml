name: Deploy OCaml docs for all Releases

on:
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # Single deploy job since we're just deploying
  deploy-docs:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Checkout | Fetch tags
        run: git fetch --tags origin

      - name: Setup | Update
        run: sudo apt-get update

      - name: Setup | System
        run: sudo apt-get install opam libgmp-dev ninja-build

      - name: Setup | OCaml
        run: |
          opam init --auto-setup --disable-sandboxing --yes --bare
          opam switch create 4.12.0 --yes
          eval $(opam env)
          opam install --yes ocamlfind odoc ctypes zarith cppo dune

      - name: Setup | Pages
        uses: actions/configure-pages@v2

      - name: Build | OCaml API Reference for Tags
        run: |
          mkdir -p build/ocaml
          for branch in $(git for-each-ref --format='%(refname)' refs/tags/); do
            if [[ "$branch" == *"ocaml-"* ]]; then
              rm -rf opam
              tag=$(echo $branch | cut -d'/' -f 3)
              git checkout $tag
              echo "Building documentation for $tag"
              mkdir -p build/ocaml/$tag
              ./opam.sh
              cd opam
              eval $(opam env)
              opam install . --yes --assume-depexts
              dune build @doc --only-packages=hacl-star
              cp -r _build/default/_doc/_html/* ../build/ocaml/$tag/
              cd ../
            fi
          done

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v1
        with:
          path: "build"

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v1
